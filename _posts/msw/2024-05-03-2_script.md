---
title: "[메이플스토리 월드] 2. 스크립트"

categories: 
    - MSW
tag: 
    - [메이플스토리 월드, 게임 프로그래밍, Lua]
toc: true

date: 2024-05-03
last_modified_at: 2024-05-03

---


## 1️⃣ 로그 출력

스크립트를 이용해 "Hello World" 로그를 출력해보자.

### 🔸스크립트 컴포넌트 생성

1. WorkSpace > MyDesk > Create Script > Create Component

2. 컴포넌트 이름으로 HelloWorld 입력
3. HelloWorld 더블 클릭하여 스크립트 에디터 띄우기



### 🔸스크립트 작성

```lua
HelloWorld {
    Property:
    Function:
    void OnBeginPlay()
    {
        log("Hello World")
	}
    
    Entity Event Handler:
}

```

![log_helloworld](D:\Blog\podola.github.io\assets\images\2024-05-03-2_script\log_helloworld.png)

### 🔸엔티티에 추가



## 2️⃣ 모델

### 🔸모델이란

원하는 엔티티를 만들려면, 엔티티에 컴포넌트를 추가하고 프로퍼티를 수정해야 한다.

모델은 위 정보들을 저장해 재사용성을 높인다.

원하는 엔티티의 콘텍스트 메뉴에서 **Create Model From Entity**를 클릭하면 엔티티를 모델화 할 수 있다.



### 🔸모델의 확장

모델은 자신의 컴포넌트와 프로퍼티 값을 물려받은 확장 모델을 생성할 수 있다.

워크스페이스에서 원하는 모델을 선택 후 컨텍스트 메뉴에서 **Extend**를 클릭해 확장 모델은 만든다.

자식 모델은 부모 모델의 컴포넌트와 프로퍼티 초깃값을 물려받는다.

부모 모델을 수정하면, 자식 모델에도 같은 변화가 적용된다.

모델 간의 관계는 프로퍼티 에디터의 **Model Extension Info**로 확인할 수 있다.



### 🔸신규 모델 생성

워크스페이스의 콘텍스트 메뉴에서 **Create Model**을 클릭해서 빈 모델을 생성합니다.

또는 이미 배치 되어있는 엔티티의 콘텍스트 메뉴의 **Create Model From Entity**를 클릭해 엔티티 모델을 만들 수 있습니다.



### 🔸모델의 엔티티 생성

원하는 모델을 씬으로 드래그 하면 됩니다.



### 🔸모델 프로퍼티

프로퍼티 에디터 최상단에는 어떤 컴포넌트에도 속하지 않은 프로퍼티있는데, 이것이 모델 프로퍼티이다.

모델 프로퍼티는 모델에 포함된 컴포넌트의 일부 프로퍼티를 즐겨찾기처럼 모은 것이다.



## 3️⃣ 맵 레이어

### 🔸맵레이어 이해하기

레이어란 맵 화면 위에 올리는 투명한 판이다.

판 위에 여러 엔티티를 올리고, 또 다른 판을 올리면 새로운 엔티티를 배치할 수 있다.



### 🔸레이어 우선순위

메이커에서 엔티티 순서는 아래 순서로 결정된다.

1. Map Layer
2. SpriteRendererComponent의 OrderInLayer 프로퍼티
3. TransformComponent의 Position Z 값

<br>

모델은 배치 편의를 위해 유형 별로 OrderInLayer 기본값이 정해져 있다.

- 오브젝트 : 0
- 타일 : 1
- 몬스터, NPC, 발판, 포탈, 아이템 등 : 2
- 타 이용자의 아바타 : 3
- 나의 아바타 : 4



### 🔸플레이어 아바타

플레이어 아바타는 엔티티지만 특정 레이어에 귀속되지 않음.

대신 현제 밟고 있는 엔티티(타일, 발판 등)의 맵 레이어로 소속이 계속 바뀐다.

나무 레이어와 발판 레이어의 우선순위에 따라 플레이어는 나무의 앞 또는 뒤로 지나간다.





## 4️⃣ 좌표

### 🔸월드 좌표

월드 좌표는 월드에서 특정 위치 값.

엔티티의 프로퍼티 중 TransformComponent의 **WorldPosition**이 월드 좌표이다.



### 🔸스크린 좌표

스크린 좌표는 화면 상의 위치 값.

스크린에 UI 요소를 배치한다.

유저 디바이스에 따라 원하는 곳에 UI를 보여주려면 **Anchor Presets** 기능을 활용해야 한다.



## 5️⃣ 타입

### 🔸타입 이해하기

메이플스토리 월드에서 타입이란 프로퍼티 및 함수를 조합하여 하나의 새로운 데이터 유형은 만드는 사용자 정의 자료형이다.

타입을 활용해 유사한 데이터를  한 번에 제어하고 관리할 수 있다.



### 🔸타입과 컴포넌트의 차이

- 타입은 엔티티에 추가할 수 없다.
- 타입은 실행 제어 기능을 지원하지 않는다.
- 타입에는 이벤트 핸들러가  없다.
- 각 타입의 용도에 맞는 기본 이벤트 함수가 제공되기도 한다.



### 🔸타입의 특징과 종류

#### · Event Type

새로운 EventType을 정의할 때 사용한다. 

Event System과 연동된다.

#### · ItemType

무기, 포션, 기타 등 아이템을 분류해 정의할 때 사용한다. 

ItemService와 연동됨.

스크립트에서 `OnCreate()`를 사용할 수 있다.

#### · BTNodeType

몬스터나 NPC의 Action 노드를 생성할 때 BTNodeType 스크립트를 사용함.

Action 노드는 엔티티의 행동 또는 행동에 대한 조건을 정의한다.

#### · State Type

새로운 상태를 만들 때 사용한다.

스크립트에서 기본 이벤트 함수인 `OnEnter()`, `OnUpdate()`, `OnExit()`, `OnConditionCheck()`를 사용할 수 있다.

#### · Struct Type

사용자가 직접 변수들을 묶어서 사용할 때 유용하다.



## 6️⃣스크립트 라이프 사이클

### 🔸기본 이벤트 함수의 라이프 사이클

실행 환경에 따라 라이프 사이클의 차이가 있다.

실행 환경은 **제작/출시, 서버/클라이언트**로 구분된다.



#### · 기본 이벤트 함수

메이플 스토리 월드가 만든 함수.

호출 시점이 정해져 있다.



#### · 라이프 사이클 로깅

1. LifeCycle 컴포넌트를 생성하고 기본 이벤트 함수들을 추가한다.
2. LifeCycle 컴포넌트를 DefaultPlayer에 추가한다.
3. 맵을 추가하고 포털을 사용해 연결한다.
4. 월드를 실행하고, 포털로 맵을 이동한 뒤, 실행을 종료한다.

`OnInitialize()` > `OnMapEnter()`> `OnBeginPlay()`> `OnMapLeave()` > `OnMapEnter()` >

`OnEndPlay()` > `OnMapLeave()` > `OnDestroy()`



#### · 사용자 정의 함수

사용자가 직접 정의하는 함수.

호출 시점을 기본 이벤트 함수와 엔티티 이벤트 함수에서 호출해 사용할 수 있다.



### 🔸전체 플레이 라이프 사이클

서버와 클라이언트가 호출되는 전체 흐름을 알아보자.

플레이 라이프 사이클은 제작 중인 월드와 출시된 월드에서 약간의 차이가 있다.

가장 큰 차이는 맵을 불러오는 방식이다.

- **제작 중인 월드**에서 플레이할 때는 10개의 맵을 만들었더라도 플레이어가 있는 맵만 불러온다.
- **출시된 월드**에서는 플레이어 유무와 상관없이 모든 맵을 불러온다.
- 

#### · World 개념 이해하기

월드는 최상위 레벨의 엔티티로 실행 환경에 따라 하나씩 생성된다.

동시에 여러 월드가 존재할 수 있지만, 월드끼리 상호작용은 불가능하다.



#### · 제작 중인 월드에서 플레이 할 때

제작 중인 월드에서는 클라이언트 편집용 월드만 존재한다.

편집용 엔티티는 `OnBeginPlay()` , `OnUpdate()`,`OnEndPlay()` 가 호출되지 않지만, 렌더링이 필요한 컴포넌트는 예외로  `OnUpdate()`가 호출된다.

테스트를 위한 월드를 실행하면 편집용 월드가 비활성화된다.

그 후 로컬 서버 실행과 접속을 하고, 서버와 클라이언트에서 모두 테스트 플레이용 월드를 생성한다.

**이때 서버는 편집 중인 맵만 불러온다.**

플레이어가 포탈을 타고 다른 맵으로 이동하거나, EntityService를 사용해 다른 맵의 엔티티를 얻으면 해당 맵을 불러온다.

#### · 출시된 월드에서 플레이 할 때

출시된 게임 서버는 시작 시 전체 맵을 불러오고, 클라이언트는 늘 플레이어 엔티티가 존재하는 맵만 불러온다.



## 7️⃣월드

### 🔸월드 인스턴스

월드 인스턴스란 메이커에서 제작한 월드의 정보를 기반으로 생성한 실제 객체이다.

독립적으로 실행되며, 제작 방식에 따라 정적 룸과 인스턴스 룸이 구성된다.

월드 인스턴스는 저마다 개별적으로 실행된다.

통신이나 이벤트 전달이 필요하다면 RoomService와 WorldInstanceService를 활용해야 한다.

### 🔸생성과 파괴

월드 출시 단계에서 최대 플레이어 수를 설정한다.

최대 플레이어 수가 10인 월드에 100명이 접속했다면, 월드 인스턴스가 10개 생성된다.

모든 유저가 플레이를 종료해 남아있는 유저가 없다면 월드 인스턴스는 파괴된다.

월드 인스턴스는 생성된 후 일정 시간이 지나면 새로운 유저의 접속을 허용하지 않는다. (은퇴 준비)

### 🔸유저 할당

생성된 월드 인스턴스가 없을때 유저가 들어오면 새로운 월드 인스턴스를 하나 생성해, 정원이 찰 때까지 해당 월드 인스턴스로 보낸다.

정원이 차면 새로운 월드 인스턴스를 생성해 유저를 보낸다.

여러 개의 월드 인스턴스를 운영 중인 상황에 유저들이 월드를 떠나면 빈자리가 발생한다.

그러면 새로운 유저는 기존의 월드 인스턴스 중 유저가 가장 많은 곳으로 보낸다.

단, 은퇴 준비를 시작한 월드 인스턴스는 대상에 포함되지 않는다.






***

<br>

    이 글은 메이플스토리 월드 기본 제작 가이드를 참고하여 작성했습니다.
    잘못된 내용이나 오타가 있을 경우 메일로 지적바랍니다!😄

[맨 위로 이동하기](#){: .btn .btn--primary }{: .align-right}